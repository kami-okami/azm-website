<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ title or "موقع الشركة" }} | {{ company or "الشركة" }}</title>
  <!-- head-version: 2025-10-10-Step7 -->

  <!-- Enable DNS prefetching for cross-origins -->
  <meta http-equiv="x-dns-prefetch-control" content="on">

  <!-- Favicons -->
  <!-- Primary favicon for Google Search -->
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}?v=1">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}?v=1">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}?v=1">
  <link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}?v=1">
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}?v=1">

  {% if meta_description %}
    <meta name="description" content="{{ meta_description }}">
  {% else %}
    <meta name="description" content="عزم لتجارة قطع الغيار ومستلزمات الطرق والجسور — منتجات موثوقة تشمل مفاصل التمدد، مساند الارتكاز، وقطع غيار المحركات لمشاريع الطرق والجسور في العراق.">
  {% endif %}

  <!-- Canonical -->
  <link rel="canonical" href="{{ request.url_root.rstrip('/') }}{{ request.path }}">

  <!-- hreflang -->
  <link rel="alternate" hreflang="ar-IQ" href="{{ request.url_root.rstrip('/') }}{{ request.path }}">
  <link rel="alternate" hreflang="x-default" href="{{ request.url_root.rstrip('/') }}{{ request.path }}">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:locale" content="ar_IQ">
  <meta property="og:site_name" content="{{ company or 'الشركة' }}">
  <meta property="og:title" content="{{ title or 'موقع الشركة' }} | {{ company or 'الشركة' }}">
  <meta property="og:description" content="{{ meta_description or 'عزم لتجارة قطع الغيار ومستلزمات الطرق والجسور — منتجات موثوقة تشمل مفاصل التمدد، مساند الارتكاز، وقطع غيار المحركات.' }}">
  <meta property="og:url" content="{{ request.url_root.rstrip('/') }}{{ request.path }}">
  <meta property="og:image" content="{{ url_for('static', filename='logo.png', _external=True) }}">

  <!-- Structured Data (Organization + LocalBusiness) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": ["Organization","LocalBusiness"],
    "name": "{{ company or 'عزم لتجارة قطع الغيار ومستلزمات الطرق والجسور' }}",
    "url": "{{ request.url_root.rstrip('/') }}",
    "email": "mailto:ahmad@azmsupply.com",
    "telephone": ["+9647802280589","+9647740818896","+9647518232611"],
    "address": { "@type": "PostalAddress", "addressCountry": "IQ" },
    "areaServed": "IQ",
    "logo": "{{ url_for('static', filename='logo.png', _external=True) }}",
    "image": "{{ url_for('static', filename='logo.png', _external=True) }}",
    {% if facebook_url %}"sameAs": ["{{ facebook_url }}"],{% endif %}
    "knowsAbout": [
      "bridge expansion joints","elastomeric bearings","road milling picks",
      "asphalt cutting","construction equipment spare parts","Iraq roads and bridges"
    ],
    "contactPoint": [
      {"@type":"ContactPoint","telephone":"+9647802280589","contactType":"sales","areaServed":"IQ","availableLanguage":["ar","en"]},
      {"@type":"ContactPoint","telephone":"+9647740818896","contactType":"sales","areaServed":"IQ","availableLanguage":["ar","en"]},
      {"@type":"ContactPoint","telephone":"+9647518232611","contactType":"sales","areaServed":"IQ","availableLanguage":["ar","en"]}
    ]
  }
  </script>

  <!-- Performance: preconnect + dns-prefetch for Google Fonts -->
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- Async-load Google Fonts CSS (swap) -->
  <link rel="preload" as="style"
        href="https://fonts.googleapis.com/css2?family=Changa:wght@600;700;800&family=Tajawal:wght@400;500;700&display=swap"
        onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Changa:wght@600;700;800&family=Tajawal:wght@400;500;700&display=swap">
  </noscript>

  <!-- Preload hero image (responsive WebP) -->
  <link rel="preload" as="image"
        imagesrcset="
          {{ url_for('static', filename='img/hero/hero-640.webp') }} 640w,
          {{ url_for('static', filename='img/hero/hero-1280.webp') }} 1280w,
          {{ url_for('static', filename='img/hero/hero-1920.webp') }} 1920w"
        imagesizes="(max-width: 767px) 100vw, (max-width: 1439px) 100vw, 100vw"
        href="{{ url_for('static', filename='img/hero/hero-1280.webp') }}">

  <!-- NEW: Preload stylesheet to shorten render-blocking wait -->
  <link rel="preload" as="style" href="{{ url_for('static', filename='style.css') }}?v=40">

  <!-- cache-buster v=18 -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=40">

  {# === Meta Pixel (guarded) === #}
  {% if META_PIXEL_ID %}
  <!-- Meta Pixel -->
  <script>
    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
    n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
    t.src='https://connect.facebook.net/en_US/fbevents.js';
    s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window, document,'script');
    fbq('init', '{{ META_PIXEL_ID }}');
    fbq('track', 'PageView');
  </script>
  <noscript>
    <img height="1" width="1" style="display:none"
         src="https://www.facebook.com/tr?id={{ META_PIXEL_ID }}&ev=PageView&noscript=1"/>
  </noscript>
  <!-- /Meta Pixel -->
  {% endif %}

  <!-- Helpers for dedup + cookie access -->
  <script>
    window.azm = window.azm || {};
    azm.uuidv4 = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
      const r = crypto.getRandomValues(new Uint8Array(1))[0] & 15;
      const v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
    azm.getCookie = (name) => {
      const m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
      return m ? m[2] : undefined;
    };
  </script>
</head>
<body>

  <header class="site-header">
    <div class="container nav-wrap">
      <a class="brand" href="{{ url_for('home') }}">
        <picture class="brand-logo-wrap">
          <source type="image/svg+xml" srcset="{{ url_for('static', filename='logo.svg') }}">
          <img src="{{ url_for('static', filename='logo.png') }}" class="brand-logo" alt="شعار الشركة" width="204" height="68">
        </picture>
        <div class="brand-text">
          <span class="site-title">{{ company }}</span>
          <span class="site-subtitle">قطع غيار عالية الجودة · حلول للجسور والطرق · تغطية لجميع المحافظات</span>
        </div>
      </a>

      <!-- Hamburger -->
      <button id="navToggle" class="hamburger" aria-label="القائمة" aria-expanded="false" aria-controls="primaryNav">
        <span></span><span></span><span></span>
      </button>

      <nav id="primaryNav" class="nav">
        {% if facebook_url %}
        <div class="social">
          <a class="icon-link" href="{{ facebook_url }}" target="_blank" rel="noopener" aria-label="فيسبوك" title="صفحتنا على فيسبوك">
            <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
              <path fill="currentColor" d="M22 12.06C22 6.49 17.52 2 12 2S2 6.49 2 12.06c0 5.01 3.66 9.16 8.44 9.94v-7.03H7.9v-2.9h2.54V9.41c0-2.5 1.49-3.88 3.78-3.88 1.1 0 2.25.2 2.25.2v2.48h-1.27c-1.25 0-1.64.78-1.64 1.58v1.9h2.79l-.45 2.9h-2.34V22c4.78-.78 8.44-4.93 8.44-9.94z"/>
            </svg>
          </a>
        </div>
        {% endif %}

        <a href="{{ url_for('home') }}" class="{% if active_page == 'home' %}active{% endif %}">الرئيسية</a>
        <a href="{{ url_for('about') }}" class="{% if active_page == 'about' %}active{% endif %}">من نحن</a>
        <a href="{{ url_for('products') }}" class="{% if active_page == 'products' %}active{% endif %}">المنتجات</a>
        <a href="{{ url_for('catalog') }}" class="{% if active_page == 'catalog' %}active{% endif %}">الكاتلوك</a>
        <a class="btn small {% if active_page == 'contact' %}active{% endif %}" href="{{ url_for('contact') }}">تواصل معنا</a>

        {% if session.get('logged_in') %}
          <a href="{{ url_for('admin_messages') }}">لوحة الإدارة</a>
          <form action="{{ url_for('logout') }}" method="post" style="display:inline">
            <input type="hidden" name="_csrf" value="{{ csrf_token }}">
            <button type="submit" style="background:none;border:none;color:#fff;font-weight:700;cursor:pointer">تسجيل الخروج</button>
          </form>
        {% endif %}
      </nav>
    </div>
  </header>

  <main class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-wrap">
          {% for category, msg in messages %}
            <div class="flash {{ category }}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>

  <footer class="container footer">
    <div>© 2025 جميع الحقوق محفوظة · {{ company }}</div>
    <div class="contacts">
      <strong>هاتف:</strong> 07802280589 · 07740818896 · 07518232611
      <p>ahmad@azmsupply.com</p>
    </div>
  </footer>

  {% if whatsapp_number %}
  <a class="whatsapp-fab"
     href="https://wa.me/{{ whatsapp_number }}?text={{ whatsapp_text_encoded }}"
     target="_blank" rel="noopener"
     aria-label="تواصل عبر واتساب" title="تواصل عبر واتساب">
    <svg viewBox="0 0 32 32" width="26" height="26" aria-hidden="true">
      <path fill="currentColor" d="M19.11 17.09c-.29-.15-1.7-.84-1.96-.93-.27-.1-.47-.15-.66.15-.19.29-.76.93-.93 1.12-.17.19-.34.22-.63.07-.29-.15-1.23-.45-2.34-1.44-.86-.76-1.45-1.7-1.62-1.99-.17-.29-.02-.45.13-.6.13-.13.29-.34.44-.51.15-.17.19-.29.29-.49.1-.19.05-.36-.02-.51-.07-.15-.66-1.59-.9-2.17-.24-.58-.49-.5-.66-.51-.17-.01-.36-.01-.55-.01-.19 0-.51.07-.78.36-.27.29-1.03 1.01-1.03 2.46 0 1.45 1.06 2.85 1.21 3.04.15.19 2.09 3.19 5.06 4.47.71.31 1.26.49 1.69.63.71.23 1.35.2 1.86.12.57-.09 1.7-.69 1.94-1.36.24-.67.24-1.25.17-1.39-.07-.14-.26-.22-.55-.36zM16 3C8.83 3 3 8.83 3 16c0 2.3.6 4.46 1.66 6.35L3 29l6.81-1.78C11.6 28.4 13.75 29 16 29c7.17 0 13-5.83 13-13S23.17 3 16 3z"/>
    </svg>
  </a>
  {% endif %}

  <!-- Mobile menu toggle: run after load/idle to avoid any render-phase reflow -->
  <script>
    (function initNav(){
      function wire() {
        const toggle = document.getElementById('navToggle');
        const nav = document.getElementById('primaryNav');
        if (!toggle || !nav) return;
        const closeNav = () => { nav.classList.remove('open'); toggle.setAttribute('aria-expanded','false'); };
        const openNav  = () => { nav.classList.add('open');    toggle.setAttribute('aria-expanded','true');  };
        toggle.addEventListener('click', () => { nav.classList.contains('open') ? closeNav() : openNav(); });
        nav.addEventListener('click', (e) => { if (e.target.closest('a')) closeNav(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeNav(); });
      }
      if ('requestIdleCallback' in window) {
        requestIdleCallback(wire, {timeout: 1000});
      } else {
        window.addEventListener('load', wire, { once: true });
      }
    })();
  </script>

  {# ===== CAPI wiring (browser+server with dedup). No UI changes. ===== #}
  {% if META_PIXEL_ID %}
  <script>
    (function(){
      // 1) Lead on contact form submit
      document.addEventListener('DOMContentLoaded', function(){
        const form = document.querySelector('form.form') || document.querySelector('form[action*="contact"]');
        if (!form) return;

        form.addEventListener('submit', function(){
          const eventId = azm.uuidv4();

          // Browser event (dedup)
          try { fbq && fbq('track', 'Lead', { eventID: eventId }); } catch(e){}

          // Prepare payload for server (hashing is done server-side)
          const ph = form.querySelector('input[name="phone"]')?.value || '';
          const em = form.querySelector('input[name="email"]')?.value || '';
          const ext = form.querySelector('input[name="name"]')?.value || '';

          const payload = {
            event_name: 'Lead',
            event_id: eventId,
            fbp: azm.getCookie('_fbp'),
            fbc: azm.getCookie('_fbc'),
            ph: ph,
            em: em,
            external_id: ext
          };

          const send = () => {
            const body = JSON.stringify(payload);
            if (navigator.sendBeacon) {
              navigator.sendBeacon('/capi/track', new Blob([body], {type:'application/json'}));
            } else {
              fetch('/capi/track', {method:'POST', headers:{'Content-Type':'application/json'}, body});
            }
          };
          send();
        }, { once: true }); // avoid double fire on repeated submits
      });

      // 2) Contact on WhatsApp/phone link click (auto-detect by href)
      document.addEventListener('click', function(e){
        const el = e.target.closest('a[href]');
        if (!el) return;
        const href = el.getAttribute('href') || '';
        const isWhatsApp = href.includes('wa.me') || href.includes('api.whatsapp.com');
        const isPhone = href.startsWith('tel:');
        if (!isWhatsApp && !isPhone) return;

        const eventId = azm.uuidv4();
        try { fbq && fbq('track', 'Contact', { eventID: eventId }); } catch(e){}

        const payload = {
          event_name: 'Contact',
          event_id: eventId,
          fbp: azm.getCookie('_fbp'),
          fbc: azm.getCookie('_fbc'),
          source: isWhatsApp ? 'whatsapp' : 'phone'
        };

        const body = JSON.stringify(payload);
        if (navigator.sendBeacon) {
          navigator.sendBeacon('/capi/track', new Blob([body], {type:'application/json'}));
        } else {
          fetch('/capi/track', {method:'POST', headers:{'Content-Type':'application/json'}, body});
        }
      });

      // 3) ViewContent on /catalog
      document.addEventListener('DOMContentLoaded', function(){
        try {
          if (location && location.pathname && location.pathname.replace(/\/+$/,'') === '/catalog') {
            const eventId = azm.uuidv4();
            try { fbq && fbq('track', 'ViewContent', { eventID: eventId }); } catch(e){}
            const payload = {
              event_name: 'ViewContent',
              event_id: eventId,
              fbp: azm.getCookie('_fbp'),
              fbc: azm.getCookie('_fbc'),
              content_name: 'Catalog'
            };
            const body = JSON.stringify(payload);
            if (navigator.sendBeacon) {
              navigator.sendBeacon('/capi/track', new Blob([body], {type:'application/json'}));
            } else {
              fetch('/capi/track', {method:'POST', headers:{'Content-Type':'application/json'}, body});
            }
          }
        } catch(e){}
      });
    })();
  </script>
  {% endif %}

  {% block extra_scripts %}{% endblock %}
</body>
</html>
