{% extends "base.html" %}
{% block content %}
<h2 class="page-title">تواصل معنا</h2>
<p>املأ النموذج التالي وسنعاود الاتصال بكم في أقرب وقت.</p>

<form class="form" method="post" action="{{ url_for('contact') }}">
  <input type="hidden" name="_csrf" value="{{ csrf_token }}">

  <input type="text" name="name" placeholder="الاسم الكامل *" required>

  <input
    type="tel"
    name="phone"
    inputmode="numeric"
    autocomplete="tel-national"
    dir="ltr"
    required
    pattern="^(?:0?7[5789]\d{8}|(?:\+?964)?7[5789]\d{8})$"
    title="أدخل رقم هاتف عراقي صحيح يبدأ بـ 075 أو 077 أو 078 أو 079 (مثال: 07802280589 أو +9647802280589)."
    placeholder="ادخل رقم هاتف صحيح"
  />

  <input type="email" name="email" placeholder="البريد الإلكتروني (اختياري)">
  <input type="text" name="subject" placeholder="الموضوع (اختياري)">
  <textarea name="message" rows="5" placeholder="نص الرسالة *" required></textarea>

  <!-- Single reCAPTCHA widget -->
  <div class="g-recaptcha" data-sitekey="{{ recaptcha_site_key }}"></div>

  <button class="btn" type="submit">إرسال</button>
</form>
{% endblock %}

{% block extra_scripts %}
  <!-- Load reCAPTCHA once -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>

  <!-- Optional UX guard for deny-listed numbers (server still enforces) -->
  <script>
  (function () {
    const deny = new Set(["07802280589","07740818896","07518232611"]);
    const input = document.querySelector('input[name="phone"]');

    function normalize(raw) {
      if (!raw) return "";
      let d = raw.replace(/\D/g, "");
      if (d.startsWith("00964")) d = d.slice(5);
      else if (d.startsWith("964")) d = d.slice(3);
      if (d.startsWith("0")) d = d.slice(1);
      // Expect 10 digits starting with 7 → return 0 + digits
      if (d.length === 10 && d.startsWith("7")) return "0" + d;
      return raw; // leave as-is; pattern will reject
    }

    function check() {
      if (!input) return;
      const n = normalize(input.value);
      if (deny.has(n)) {
        input.setCustomValidity("يرجى إدخال رقم هاتف مختلف.");
      } else {
        input.setCustomValidity("");
      }
    }

    if (input) {
      input.addEventListener("input", check);
      input.addEventListener("change", check);
    }

    // Prevent double submit
    const form = document.querySelector('form[action="{{ url_for("contact") }}"]');
    if (form) {
      form.addEventListener('submit', function () {
        const btn = form.querySelector('button[type="submit"]');
        if (btn) btn.disabled = true;
      });
    }
  })();
  </script>
{% endblock %}
